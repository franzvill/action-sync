apiVersion: v1
kind: Secret
metadata:
  name: meeting-jira-secrets
  labels:
    app: meeting-jira
type: Opaque
stringData:
  SECRET_KEY: "meeting-jira-prod-secret-key-2024-change-this"
  DATABASE_URL: "postgresql+asyncpg://meeting_jira:meeting_jira_secret@meeting-jira-postgres:5432/meeting_jira"
  POSTGRES_PASSWORD: "meeting_jira_secret"
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: meeting-jira-postgres-pvc
  labels:
    app: meeting-jira
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: meeting-jira-postgres
  labels:
    app: meeting-jira
    component: postgres
spec:
  replicas: 1
  selector:
    matchLabels:
      app: meeting-jira
      component: postgres
  template:
    metadata:
      labels:
        app: meeting-jira
        component: postgres
    spec:
      containers:
        - name: postgres
          image: postgres:16-alpine
          ports:
            - containerPort: 5432
          env:
            - name: POSTGRES_USER
              value: "meeting_jira"
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: meeting-jira-secrets
                  key: POSTGRES_PASSWORD
            - name: POSTGRES_DB
              value: "meeting_jira"
            - name: PGDATA
              value: "/var/lib/postgresql/data/pgdata"
          volumeMounts:
            - name: postgres-storage
              mountPath: /var/lib/postgresql/data
          readinessProbe:
            exec:
              command:
                - pg_isready
                - -U
                - meeting_jira
            initialDelaySeconds: 5
            periodSeconds: 10
          livenessProbe:
            exec:
              command:
                - pg_isready
                - -U
                - meeting_jira
            initialDelaySeconds: 30
            periodSeconds: 10
      volumes:
        - name: postgres-storage
          persistentVolumeClaim:
            claimName: meeting-jira-postgres-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: meeting-jira-postgres
  labels:
    app: meeting-jira
    component: postgres
spec:
  selector:
    app: meeting-jira
    component: postgres
  ports:
    - port: 5432
      targetPort: 5432
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: meeting-jira
  labels:
    app: meeting-jira
    component: app
spec:
  replicas: 1
  selector:
    matchLabels:
      app: meeting-jira
      component: app
  template:
    metadata:
      labels:
        app: meeting-jira
        component: app
    spec:
      containers:
        - name: meeting-jira
          image: nexus-docker.devops.msccruises.com/otalio-virtualconcierge/meeting-jira:v17
          ports:
            - containerPort: 8080
          env:
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: meeting-jira-secrets
                  key: DATABASE_URL
            - name: SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: meeting-jira-secrets
                  key: SECRET_KEY
            - name: AZURE_ANTHROPIC_ENDPOINT
              valueFrom:
                secretKeyRef:
                  name: meeting-jira-azure
                  key: AZURE_ANTHROPIC_ENDPOINT
                  optional: true
            - name: AZURE_ANTHROPIC_API_KEY
              valueFrom:
                secretKeyRef:
                  name: meeting-jira-azure
                  key: AZURE_ANTHROPIC_API_KEY
                  optional: true
            - name: AZURE_ANTHROPIC_MODEL
              value: "claude-opus-4-5"
            - name: HOME
              value: "/tmp"
          readinessProbe:
            httpGet:
              path: /
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 30
          resources:
            requests:
              memory: "512Mi"
              cpu: "200m"
            limits:
              memory: "2Gi"
              cpu: "1000m"
---
apiVersion: v1
kind: Service
metadata:
  name: meeting-jira
  labels:
    app: meeting-jira
    component: app
spec:
  selector:
    app: meeting-jira
    component: app
  ports:
    - port: 8080
      targetPort: 8080
---
apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: actionsync
  labels:
    app: meeting-jira
spec:
  host: actionsync.apps.ocpdc-ch-dev.msccruises.com
  to:
    kind: Service
    name: meeting-jira
  port:
    targetPort: 8080
  tls:
    termination: edge
    insecureEdgeTerminationPolicy: Redirect
